
      LM=1

MAIN:
      RULE.EXP = TRIM(UPCASE(RULE.EXP))
      RULE.B = ""
      RULE.B<1> = FIELD(RULE.EXP,";",1)
      RULE.B<2> = FIELD(RULE.EXP,";",2)
      CRITERIA = RULE.B<1>
      ACTION = RULE.B<2>
      WRITE RULE.B ON RULES,RULE.ID
      GOSUB PARSE.CRITERIA:
      IF TRANS.LIST THEN GOSUB APPLY.ACTION:
      RETURN

APPLY.ACTION:
      ACTION = CHANGE(ACTION,":",@FM)
      IF ACTION = "N" THEN ATT.NUM = 6
      IF ACTION = "C" THEN ATT.NUM = 13
      ATT = ACTION<1>
      VALUE = ACTION<2>
      LIST.CT = DCOUNT(TRANS.LIST,@FM)
      FOR LIST.X = 1 TO LIST.CT
         TRANS.ID = TRANS.LIST<LIST.X>
         READ TRANS.B FROM TRANS,TRANS.ID THEN
            TRANS.B<ATT.NUM> = VALUE
            WRITE TRANS.B ON TRANS,TRANS.ID
         END
      NEXT LIST.X
      RETURN

PARSE.CRITERIA:
      IF DCOUNT(CRITERIA,"&") > 1 THEN
         CRIT1 = FIELD(CRITERIA,"&",1)
         CRIT2 = FIELD(CRITERIA,"&",2)
         CRIT.JOIN = "&"
      END ELSE
         IF DCOUNT(CRITERIA,"|") > 1 THEN
            CRIT1 = FIELD(CRITERIA,"|",1)
            CRIT2 = FIELD(CRITERIA,"|",2)
            CRIT.JOIN = "|"
         END ELSE
            CRIT2 = ""
            CRIT.JOIN = ""
         END
      END
      CRIT = CRIT1
      GOSUB EXPAND.CRIT:
      GOSUB SELECT.CRIT:
      IF SEL.CT THEN
         IF CRIT2 THEN
            EXECUTE "SAVE-LIST 3"
            CRIT = CRIT2
            GOSUB EXPAND.CRIT:
            GOSUB SELECT.CRIT:
            IF SEL.CT THEN
               EXECUTE "SAVE-LIST 4"
               IF CRIT.JOIN = "&" THEN
                  EXECUTE "MERGE.LIST 3 INTERSECTION 4" CAPTURING CAP
               END ELSE
                  EXECUTE "MERGE.LIST 3 UNION 4" CAPTURING CAP
               END
            END
         END
         LIST.CT = CAP<1,2>
         IF LIST.CT THEN READLIST TRANS.LIST ELSE TRANS.LIST = ""
      END ELSE TRANS.LIST = ""
      RETURN

EXPAND.CRIT:
      BASE = FIELD(CRIT,"=",1)
      IF BASE = "D" THEN BASE = "TR.DESC"
      IF BASE = "T" THEN BASE = "TR.TYPE"
      IF BASE = "C" THEN BASE = "CLASS"
      IF BASE = "N" THEN BASE = "NAME"
      TESTS = FIELD(CRIT,"=",2)
      TEST.CT = DCOUNT(TESTS,@FM)
      TESTS = CHANGE(TESTS,",","] OR !")
      TESTS = CHANGE(TESTS,"+","] AND !")
      TESTS = CHANGE(TESTS,"!",@FM)
      FOR TEST.X = 1 TO TEST.CT
         TEST.EXP := BASE:"=[":TESTS<TEST.X>
      NEXT TEST.X
      TEST.EXP := "]"
      TEST.EXP = "SELECT TRANS WITH ":TRIM(TEST.EXP)
      RETURN

SELECT.CRIT:
      IF LM THEN PRINT TEST.EXP
      EXECUTE TEST.EXP CAPTURING CAP
      SEL.CT = CAP<1,2>
      RETURN


      EQU TR.DESC TO TRANS.B<5>, TR.TYPE TO TRANS.B<2>, TR.NAME TO TRANS.B<6>
      EQU RULE.CRIT TO RULE.B<1>, RULE.ACTION TO RULE.B<2>


      MAJ.DELIM.OR ="|"
      MAJ.DELIM.AND = "&"

      RULE.CRITERIA = RULE.B<1>
      RULE.ACTION =  RULE.B<2>
      IF INDEX(RULE.CRITERIA,"&",1) OR INDEX(RULE.CRITERIA,"|",1)

      CRIT.CT = DCOUNT(RULE.CRITERIA,@VM)
      DCOUNT(
      FOR CRIT.X = 1 TO CRIT.CT
         CRIT = CHANGE(RULE.CRITERIA<CRIT.X>,"ATT.SET")
         SELECT.STR = "SELECT TRANS WITH "
         RULE.DATA = RULE.B<3>
         IF RULE.TYPE = "N" THEN SET.ATT = 6
         IF RULE.TYPE = "C" THEN SET.ATT = 13
         RULE.CRIT1 = FIELD(RULE.CRITERIA,":",1)
         RULE.CRIT2 = FIELD(RULE.CRITERIA,":",2)
         SELECT.STR = "SELECT TRANS WITH CLASS = '' AND WITH "
         IF RULE.CRIT2 = "N" THEN SEL.STR2 = "TR.NAME"
         IF RULE.CRIT2 = "K" THEN SEL.STR2 = "TR.KEY"
         IF RULE.CRIT2 = "C" THEN SEL.STR2 = "TR.CLASS"
         IF RULE.CRIT2 = "T" THEN SEL.STR2 = "TR.TYPE"
         SELECT.STR := SEL.STR2
         SELECT.STR := ' = ':SEL.STR2 = RULE.CR
      NEXT CRIT.X

      t=a,b  k=a+b n=a,b &            &/| n=a,/+b,+/,c

      if((keyword="taxi" or keyword = "cab") or name="uber") then class = "transportation"
      k=taxi,cab|n=uber;c:transportation
      K=rite+aid;N:Rite Aid
      k=walgreen;n:walgreens;
      n=rite aid,cvs,duane reade,walgreens; c:office supplies
n:    k=cvs;n:cvs
n:    k=american+express;n:American Express
      k=gristedes; n:Gristedes c:Groceries
      k=uber;n:Uber
c:    n=uber|K=taxi;c:Transportation;
t:    k=ATM;n=ATM withdrawl c:Petty cash


rulein:
      parse criteria into rule<1>
      parse actions into rule<2>

      bases="c/class,t/trans,n/name,k/keyword"
      operands=",+-^~";* or and not in not-in



ruleout:
      get criteria
      count "="
      for each = get sub.criteria
         sc = field(criteria,",",sc.x)
         base = field(sc,"=",1)
         test.value = field(sc,"=",2)


         set valid = 0
         for each = subcriteria
            left side of = is base
            right side are tests


            if base = "c" then base.value = trans.class
            if base = "n" then base.value = trans.name
            if base = 't" then base.value = trans.type


            result = false
            begin case
               case op = "~"
                  if index(base,test.value,1) then result true
               case op = "^"
                  if index(base,test.value,1) = 0 then true
               case op = "="
                  if base = test.value then result = true
               case op = "#"
                  if base <> test.value then result = true
            end case

            expression = change(expression,","," OR ")
            expression = change(expression,"+"," AND ")

            if base.value = test.value then valid = 1
            LM=1
            EQU  KEYWORD TO RULE.B<1>, PAYEE.NAME TO RULE.B<2>, ACCOUNT.ID TO RULE.B<3>
            EQU  CLASS.NAME TO RULE.B<4>, DEPT TO RULE.B<5>, TR.IDS TO RULE.B<6>
            OPEN 'ACCOUNTS' TO ACCOUNTS ELSE PRINT 'ACCOUNTS';STOP
            INCLUDE FILE.EQU TRANS.EQ

            IF RULE.ID THEN
               READ RULE.B FROM RULES,RULE.ID ELSE RULE.B = ""
               READV ACCOUNT.NAME FROM ACCOUNTS,ACCOUNT.ID,1 ELSE ACCOUNT.NAME = ""
            END

MAIN:

            KEYWORD = TRIM(KEYWORD)
            IF LEN(KEYWORD) > 2 THEN

               SELECT.STR = 'SELECT TRANS WITH NAME_DESC LIKE "...':UPCASE(KEYWORD):'..." AND WITHOUT RULE'
               PRINT SELECT.STR
               EXECUTE SELECT.STR CAPTURING CAP
               LIST.QTY = FIELD(CAP<2>," ",1)
               PRINT LIST.QTY:" FOUND"
               READLIST TR.LIST THEN
                  LIST.CT = DCOUNT(TR.LIST,@FM)
                  FOR LIST.X = 1 TO LIST.CT
                     TR.ID = TR.LIST<LIST.X>
                     READ TR.B FROM TRANS,TR.ID THEN
                        TR.PAYEE = PAYEE.NAME
                        TR.ACCOUNT.ID = ACCOUNT.ID
                        TR.ACCOUNT.NAME = ACCOUNT.NAME
                        TR.CLASS = CLASS.NAME
                        TR.DEPT = DEPT
                        TR.RULE = RULE.ID
                        WRITE TR.B ON TRANS,TR.ID
                        IF LM THEN PRINT "APPLYING RULE ":RULE.ID:" TO TRANS ":TR.ID:" ":TR.DESC
                     END
                  NEXT LIST.X
               END
            END

            RETURN



