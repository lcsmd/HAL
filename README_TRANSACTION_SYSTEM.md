# HAL Transaction Management System

## Overview

The HAL Transaction Management System is a schema-driven financial transaction processing system fully integrated with the HAL architecture. It imports transactions from Quicken CSV exports, standardizes payee names, tags reimbursable expenses, and generates reports.

## Architecture Compliance

This system follows HAL's core principles:

- **Schema-Driven**: All data structures defined in CSV schemas
- **Generated Artifacts**: Files, dictionaries, and equates auto-generated by BUILD.SCHEMA
- **COMMON FILES Array**: Programs use `COMMON FILES(50)` for file handles
- **Equate Files**: Field positions defined in EQU/*.equ files
- **No Direct File Opening**: Uses schema-generated file handles

## Files in the System

### Data Files (5 files)

1. **TRANSACTION** (trn) - Main transaction records
   - 23 fields including date, payee, amount, category, reimbursement flags
   - Indexed: TRANS_DATE, STANDARDIZED_PAYEE, REIMBURSABLE_FLAG, IMPORT_BATCH_ID

2. **PAYEE** (pye) - Standardized payee master
   - 16 fields including standard name, aliases, auto-reimbursable flag
   - Indexed: STANDARD_NAME, AUTO_REIMBURSABLE

3. **RULE** (rul) - Processing rules
   - 12 fields for pattern matching and actions
   - Indexed: RULE_TYPE, ACTIVE_FLAG

4. **REIMBURSEMENT** (rmb) - Reimbursement batch tracking
   - 13 fields for batch management
   - Indexed: BATCH_ID, STATUS

5. **IMPORT_LOG** (iml) - Import audit trail
   - 9 fields tracking import history
   - Indexed: IMPORT_DATE

### Programs (5 programs)

1. **IMPORT.QUICKEN** - Import transactions from Quicken CSV
2. **STANDARDIZE.PAYEES** - Apply rules to standardize payee names
3. **TAG.REIMBURSABLE** - Tag transactions as reimbursable
4. **MANAGE.RULES** - Interactive rule management
5. **REPORT.REIMBURSABLE** - Generate reimbursement reports

### Schema Files (5 CSV files)

Located in `SCHEMA/`:
- TRANSACTION.csv
- PAYEE.csv
- RULE.csv
- REIMBURSEMENT.csv
- IMPORT_LOG.csv

## Installation

### Step 1: Build Schema

The schema files have already been created and added to SCHEMA_INDEX.csv and DOMAINS.CSV. Build the data structures:

```
qm -kHAL
:BUILD.SCHEMA
```

This will:
- Create all 5 data files (TRANSACTION, PAYEE, RULE, REIMBURSEMENT, IMPORT_LOG)
- Generate dictionary entries with proper conversions and formats
- Create equate files (EQU/trn.equ, EQU/pye.equ, EQU/rul.equ, EQU/rmb.equ, EQU/iml.equ)
- Update master EQU/FILES.EQU

### Step 2: Compile Programs

```
:BASIC BP IMPORT.QUICKEN
:BASIC BP STANDARDIZE.PAYEES
:BASIC BP TAG.REIMBURSABLE
:BASIC BP MANAGE.RULES
:BASIC BP REPORT.REIMBURSABLE
```

### Step 3: Catalog Programs

```
:CATALOG BP IMPORT.QUICKEN
:CATALOG BP STANDARDIZE.PAYEES
:CATALOG BP TAG.REIMBURSABLE
:CATALOG BP MANAGE.RULES
:CATALOG BP REPORT.REIMBURSABLE
```

Answer "Y" when prompted to remove from local catalog (per HAL standards).

### Step 4: Import Sample Rules (Optional)

```
:MANAGE.RULES
```

Select option 8 to import sample rules, then option 9 to exit.

## Usage

### Importing Transactions

Export your transactions from Quicken as CSV, then:

```
:IMPORT.QUICKEN C:/path/to/your/quicken_export.csv
```

The import process:
- Detects CSV column headers automatically
- Maps columns to TRANSACTION fields
- Handles multiple date formats (MM/DD/YYYY, MM/DD/YY, YYYY-MM-DD)
- Cleans currency amounts (removes $, commas)
- Stores original CSV line for reference
- Creates import log entry

### Standardizing Payees

After import, standardize payee names:

```
:STANDARDIZE.PAYEES
```

Or process only a specific batch:

```
:STANDARDIZE.PAYEES 19876-123456
```

The standardization process:
- Applies rules in priority order
- Uses fuzzy matching for similar payee names
- Creates new PAYEE records as needed
- Links transactions to PAYEE master

### Tagging Reimbursable Transactions

Tag transactions that are reimbursable:

```
:TAG.REIMBURSABLE
```

Or process only a specific batch:

```
:TAG.REIMBURSABLE 19876-123456
```

The tagging process:
- Checks if payee is marked auto-reimbursable
- Applies reimbursement rules
- Sets reimbursable flag and category
- Updates transaction status

### Managing Rules

Interactive rule management:

```
:MANAGE.RULES
```

Menu options:
1. List all rules
2. Add payee standardization rule
3. Add reimbursement tagging rule
4. Add auto-reimbursable payee
5. Edit rule
6. Delete rule
7. Activate/Deactivate rule
8. Import sample rules
9. Exit

### Generating Reports

Summary report (by category):

```
:REPORT.REIMBURSABLE SUMMARY
```

Detail report (all transactions):

```
:REPORT.REIMBURSABLE DETAIL
```

Batch report (specific import batch):

```
:REPORT.REIMBURSABLE BATCH 19876-123456
```

## Rule Types

### Payee Standardization Rules

- **PAYEE.MATCH** - Contains text (e.g., "AMAZON" matches "AMAZON.COM #123")
- **EXACT.MATCH** - Exact name match (case insensitive)
- **STARTS.WITH** - Starts with text (e.g., "CVS" matches "CVS PHARMACY #456")

### Reimbursement Tagging Rules

- **CATEGORY.MATCH** - Match transaction category
- **PAYEE.MATCH** - Match payee name
- **MEMO.MATCH** - Match memo field
- **AMOUNT.RANGE** - Match amount range (format: "MIN:MAX")

## Query Examples

Using QM's query language directly:

```
* List all reimbursable transactions
:LIST TRANSACTION WITH REIMBURSABLE.FLAG = "Y"

* Show transactions by date range
:LIST TRANSACTION WITH TRANS.DATE >= "20250101" AND TRANS.DATE <= "20250131"

* Count transactions by payee
:COUNT TRANSACTION BY STANDARDIZED.PAYEE

* Sum amounts by category
:SUM TRANSACTION AMOUNT BY REIMBURSEMENT.CATEGORY

* Show pending reimbursements
:LIST TRANSACTION WITH REIMBURSEMENT.STATUS = "PENDING"
```

## Workflow Example

Complete workflow for processing a new Quicken export:

```
* 1. Import transactions
:IMPORT.QUICKEN C:/Downloads/quicken_export.csv
  (Note the batch ID, e.g., 19876-123456)

* 2. Standardize payee names
:STANDARDIZE.PAYEES 19876-123456

* 3. Tag reimbursable transactions
:TAG.REIMBURSABLE 19876-123456

* 4. Generate summary report
:REPORT.REIMBURSABLE BATCH 19876-123456

* 5. Query specific data
:LIST TRANSACTION WITH IMPORT.BATCH.ID = "19876-123456" AND REIMBURSABLE.FLAG = "Y"
```

## Field Mappings

### TRANSACTION Record Structure

```
Field  Name                      Type  Description
-----  -------------------------  ----  ----------------------------------
1      TRANS_DATE                D     Transaction date (YYYYMMDD)
2      ORIGINAL_PAYEE            A     Original payee from import
3      STANDARDIZED_PAYEE        A     Standardized payee name
4      AMOUNT                    N     Transaction amount
5      CATEGORY                  A     Transaction category
6      ACCOUNT                   A     Account name
7      MEMO                      A     Transaction memo
8      REIMBURSABLE_FLAG         A     Y/N reimbursable flag
9      REIMBURSEMENT_CATEGORY    A     Category of reimbursement
10     REIMBURSEMENT_STATUS      A     Status (PENDING, APPROVED, PAID)
11     PAYEE_ID                  A     Link to PAYEE record
12     IMPORT_BATCH_ID           A     Import batch identifier
13     TAGS                      A     User-defined tags
14     SUBCATEGORY               A     Transaction subcategory
15     CHECK_NUMBER              A     Check number if applicable
16     TRANSACTION_TYPE          A     Type of transaction
17     CLEARED_STATUS            A     Cleared status
18     QUICKEN_TAGS              A     Tags from Quicken
19     SPLIT_FLAG                A     Y/N if split transaction
20     PARENT_TRANS_ID           A     Parent transaction ID if split
21     ADDRESS                   A     Payee address
22     CLASS                     A     Transaction class
23     RAW_CSV_LINE              T     Original CSV line
```

### PAYEE Record Structure

```
Field  Name                      Type  Description
-----  -------------------------  ----  ----------------------------------
1      STANDARD_NAME             A     Standardized payee name
2      ALIASES                   M     Alternate names (multivalued)
3      DEFAULT_CATEGORY          A     Default transaction category
4      AUTO_REIMBURSABLE         A     Y/N auto-reimbursable flag
5      REIMBURSEMENT_TYPE        A     Type of reimbursement
6      VENDOR_TYPE               A     Type of vendor
7      NOTES                     T     Additional notes
8      FIRST_SEEN_DATE           D     First transaction date
9      LAST_SEEN_DATE            D     Last transaction date
10     TRANSACTION_COUNT         N     Number of transactions
11     TOTAL_AMOUNT              N     Total amount spent
12     ADDRESS                   A     Payee address
13     PHONE                     A     Phone number
14     EMAIL                     A     Email address
15     WEBSITE                   A     Website URL
16     TAX_ID                    A     Tax ID or EIN
```

## Integration with HAL

The transaction system integrates seamlessly with HAL:

- **Domain**: Finance (fin)
- **File Numbers**: 32-36 in SCHEMA_INDEX.csv
- **Equates**: Included in master EQU/FILES.EQU
- **COMMON FILES**: Uses FILES(32) through FILES(36)

## Maintenance

### Adding New Fields

1. Edit the appropriate CSV schema file in SCHEMA/
2. Run BUILD.SCHEMA to regenerate structures
3. Recompile programs if they reference new fields

### Backing Up Data

```
:SAVE.ACCOUNT HAL C:/Backups/HAL_backup.tar
```

### Rebuilding Indexes

If needed:

```
:BUILD.INDEX TRANSACTION ALL
:BUILD.INDEX PAYEE ALL
:BUILD.INDEX RULE ALL
```

## Troubleshooting

**Problem**: "Cannot open TRANSACTION file"
**Solution**: Run BUILD.SCHEMA first to create the files

**Problem**: "Compilation errors"
**Solution**: Ensure EQU/FILES.EQU exists and includes transaction equates

**Problem**: "No fields mapped during import"
**Solution**: Check CSV header row format - should be comma-separated with standard field names

**Problem**: "Date conversion failed"
**Solution**: Ensure dates are in MM/DD/YYYY, MM/DD/YY, or YYYY-MM-DD format

## Architecture Benefits

Following HAL's schema-driven architecture provides:

1. **Consistency**: All files follow same structure and conventions
2. **Maintainability**: Schema changes propagate automatically
3. **Documentation**: CSV schemas serve as living documentation
4. **Extensibility**: Easy to add new fields or files
5. **Integration**: Works seamlessly with other HAL subsystems

## Future Enhancements

Potential additions:
- Budget tracking and variance analysis
- Recurring transaction detection
- Category hierarchy and rollups
- Multi-currency support
- Bank reconciliation
- Tax category mapping
- Receipt attachment linking

---

**Version**: 1.0
**Last Updated**: 2025-01-24
**Compatible with**: HAL Schema System v1.0
