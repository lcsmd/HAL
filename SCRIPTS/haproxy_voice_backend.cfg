# Voice Gateway Backend Configuration
# Add this to /etc/haproxy/haproxy.cfg on ubu6

# ===== In the frontend https_in section, add this ACL with other ACLs =====
    acl is_voice hdr(host) -i voice.lcs.ai

# ===== In the use_backend section, add this line with other use_backend rules =====
    use_backend voice_gateway if is_voice

# ===== Add this complete backend at the end of the file =====

# Voice Gateway WebSocket - HAL Voice Interface
backend voice_gateway
    mode http
    option http-server-close
    option forwardfor
    # WebSocket support - long timeouts for persistent connections
    timeout tunnel 3600s
    timeout client 3600s
    timeout server 3600s
    # Forward proper headers
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request set-header X-Real-IP %[src]
    # Backend server - MV1 Voice Gateway
    server voice1 10.1.34.103:8765 check inter 5000 rise 2 fall 3
    # Or use hostname: server voice1 MV1:8765 check inter 5000 rise 2 fall 3
