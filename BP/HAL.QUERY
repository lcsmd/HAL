* HAL.QUERY - Handle data query commands
* @param TEXT - The user's request text
* @param RESPONSE - Response to be sent back

SUBROUTINE HAL.QUERY(TEXT, RESPONSE)
$INSERT COMMON
$INSERT SYSCOM

* Initialize response
RESPONSE = ''

* Analyze query intent
GOSUB ANALYZE.QUERY
IF QUERY.TYPE = '' THEN
    * Unknown query type, use LLM
    RESPONSE = ''
    RETURN
END

* Process based on query type
BEGIN CASE
    CASE QUERY.TYPE = 'SCHEDULE'
        GOSUB QUERY.SCHEDULE
        
    CASE QUERY.TYPE = 'TASK'
        GOSUB QUERY.TASKS
        
    CASE QUERY.TYPE = 'HISTORY'
        GOSUB QUERY.HISTORY
        
    CASE 1
        * Unknown type, let LLM handle it
        RESPONSE = ''
END CASE

RETURN

*************************************************************************
ANALYZE.QUERY:
* Determine query type from text
QUERY.TYPE = ''
UPTEXT = UPCASE(TEXT)

* Check for schedule queries
IF INDEX(UPTEXT, 'SCHEDULE', 1) OR INDEX(UPTEXT, 'APPOINTMENT', 1) OR INDEX(UPTEXT, 'EVENT', 1) THEN
    QUERY.TYPE = 'SCHEDULE'
    RETURN
END

* Check for task queries
IF INDEX(UPTEXT, 'TASK', 1) OR INDEX(UPTEXT, 'TODO', 1) THEN
    QUERY.TYPE = 'TASK'
    RETURN
END

* Check for chat history queries
IF INDEX(UPTEXT, 'HISTORY', 1) OR INDEX(UPTEXT, 'CONVERSATION', 1) OR INDEX(UPTEXT, 'CHAT', 1) THEN
    QUERY.TYPE = 'HISTORY'
    RETURN
END

RETURN

*************************************************************************
QUERY.SCHEDULE:
* Query schedule data
OPEN 'HAL.SCHEDULE' TO F.SCHEDULE ELSE
    RESPONSE = "No schedule data found."
    RETURN
END

* Extract date from query
CALL DATE.EXTRACT(TEXT, DATE.STR, TIME.STR, EVENT.DESC)

IF DATE.STR = '' THEN
    * Default to today
    DATE.STR = OCONV(DATE(), 'D4/')
    INT.DATE = DATE()
END ELSE
    INT.DATE = ICONV(DATE.STR, 'D')
END

* Find events for the date
RESPONSE = "Here are the events for ":DATE.STR:":"
CNT = 0

SELECT F.SCHEDULE TO SEL.LIST
READLIST EVENT.IDS FROM SEL.LIST ELSE
    RESPONSE := CHAR(10):"No events found."
    RETURN
END

LOOP
    REMOVE EVENT.ID FROM EVENT.IDS SETTING MORE
    UNTIL MORE = 0 DO
        READ REC FROM F.SCHEDULE, EVENT.ID ELSE CONTINUE
        
        IF REC<2> = INT.DATE THEN
            CNT += 1
            RESPONSE := CHAR(10):CNT:". ":REC<1>:" at ":REC<5>
        END
    REPEAT
END

IF CNT = 0 THEN
    RESPONSE := CHAR(10):"No events found."
END

RETURN

*************************************************************************
QUERY.TASKS:
* Query task data
OPEN 'HAL.TASKS' TO F.TASKS ELSE
    RESPONSE = "No task data found."
    RETURN
END

* Check for specific status
SHOW.COMPLETED = INDEX(UPTEXT, 'COMPLETE', 1) OR INDEX(UPTEXT, 'DONE', 1) OR INDEX(UPTEXT, 'FINISHED', 1)
SHOW.ALL = INDEX(UPTEXT, 'ALL', 1)

IF SHOW.COMPLETED THEN
    RESPONSE = "Here are your completed tasks:"
END ELSE IF SHOW.ALL THEN
    RESPONSE = "Here are all your tasks:"
END ELSE
    RESPONSE = "Here are your pending tasks:"
END

CNT = 0

SELECT F.TASKS TO SEL.LIST
READLIST TASK.IDS FROM SEL.LIST ELSE
    RESPONSE := CHAR(10):"No tasks found."
    RETURN
END

LOOP
    REMOVE TASK.ID FROM TASK.IDS SETTING MORE
    UNTIL MORE = 0 DO
        READ REC FROM F.TASKS, TASK.ID ELSE CONTINUE
        
        * Filter based on status
        IF NOT(SHOW.ALL) THEN
            IF SHOW.COMPLETED AND NOT(REC<4>) THEN CONTINUE
            IF NOT(SHOW.COMPLETED) AND REC<4> THEN CONTINUE
        END
        
        CNT += 1
        STATUS = REC<4> ? " (Completed)" : " (Pending)"
        RESPONSE := CHAR(10):CNT:". ":REC<1>:STATUS
    REPEAT
END

IF CNT = 0 THEN
    RESPONSE := CHAR(10):"No matching tasks found."
END

RETURN

*************************************************************************
QUERY.HISTORY:
* Query chat history
OPEN 'HAL.CHAT.HISTORY' TO F.HISTORY ELSE
    RESPONSE = "No chat history found."
    RETURN
END

* Default to last 5 exchanges
LIMIT = 5

* Check for specific number in query
FOR I = 1 TO LEN(TEXT)
    IF NUM(TEXT[I,1]) THEN
        NUM.STR = ''
        FOR J = I TO LEN(TEXT)
            IF NUM(TEXT[J,1]) THEN
                NUM.STR := TEXT[J,1]
            END ELSE BREAK
        NEXT J
        IF NUM.STR # '' THEN
            LIMIT = NUM.STR
            BREAK
        END
    END
NEXT I

RESPONSE = "Here are the last ":LIMIT:" exchanges:"

SELECT F.HISTORY TO SEL.LIST
READLIST CHAT.IDS FROM SEL.LIST ELSE
    RESPONSE := CHAR(10):"No history found."
    RETURN
END

CNT = DCOUNT(CHAT.IDS, @AM)
START.POS = CNT - LIMIT + 1
IF START.POS < 1 THEN START.POS = 1

FOR I = START.POS TO CNT
    CHAT.ID = CHAT.IDS<I>
    READ REC FROM F.HISTORY, CHAT.ID ELSE CONTINUE
    
    SPEAKER = REC<3>
    MSG = REC<1>
    
    RESPONSE := CHAR(10):SPEAKER:": ":MSG
NEXT I

RETURN
