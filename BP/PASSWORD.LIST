SUBROUTINE PASSWORD.LIST(PERSON.ID, CATEGORY)
* List Passwords
*
* Input: PERSON.ID - Person ID
*        CATEGORY - Optional category filter

$INCLUDE SYSCOM KEYS.H
$INCLUDE EQU/i_equate.equ

PROMPT ''

* Open password file
OPEN 'PASSWORD' TO F.PWD ELSE
   CRT "Error: PASSWORD file not found"
   RETURN
END

* Build select statement
IF CATEGORY = '' THEN
   CMD = 'SELECT PASSWORD WITH PERSON.ID = "' : PERSON.ID : '" AND ACTIVE = "Y"'
END ELSE
   CMD = 'SELECT PASSWORD WITH PERSON.ID = "' : PERSON.ID : '" AND CATEGORY = "' : CATEGORY : '" AND ACTIVE = "Y"'
END

EXECUTE CMD

* Read selected IDs
PWD.LIST = ''
PWD.COUNT = 0

LOOP
   READNEXT PWD.ID ELSE EXIT
   
   READ PWD.REC FROM F.PWD, PWD.ID THEN
      PWD.COUNT += 1
      PWD.LIST<PWD.COUNT> = PWD.ID : @FM : PWD.REC<PWD.SITE.NAME.POS> : @FM : PWD.REC<PWD.USERNAME.POS> : @FM : PWD.REC<PWD.CATEGORY.POS> : @FM : PWD.REC<PWD.FAVORITE.POS>
   END
REPEAT

IF PWD.COUNT = 0 THEN
   CRT
   CRT "No passwords found"
   CRT
   RETURN
END

* Display passwords
CRT
CRT STRING('=', 80)
CRT FMT('ID', '15L') : ' ' : FMT('Site', '25L') : ' ' : FMT('Username', '20L') : ' ' : FMT('Category', '12L')
CRT STRING('=', 80)

FOR I = 1 TO PWD.COUNT
   PWD.DATA = PWD.LIST<I>
   PWD.ID = PWD.DATA<1,1>
   SITE.NAME = PWD.DATA<1,2>
   USERNAME = PWD.DATA<1,3>
   CATEGORY = PWD.DATA<1,4>
   FAVORITE = PWD.DATA<1,5>
   
   * Add star for favorites
   IF FAVORITE = 'Y' THEN
      PREFIX = '* '
   END ELSE
      PREFIX = '  '
   END
   
   CRT PREFIX : FMT(PWD.ID, '13L') : ' ' : FMT(SITE.NAME, '25L') : ' ' : FMT(USERNAME, '20L') : ' ' : FMT(CATEGORY, '12L')
NEXT I

CRT STRING('=', 80)
CRT "Total: " : PWD.COUNT : " password(s)"
CRT

RETURN
