     *initialize
     PROGRAM PROCESS.VENDOR.UPDATES
     PROG.NAME = "PROCESS.VENDOR.UPDATES"
     * PROCESS.NEW.UPDATES  - PROCESSES ALL NEW VENDOR AND ALL NEW VENDOR UPDATES FOUND IN VENDOR,NEW, VENDOR_UPDATE,NEW AND MANUAL,NEW
     * PROCESS.NEW.UPDATES [VENDOR | VENDOR | MANUAL] [UPDATE.NAME] [UPDATE.MODE (S,L,P,LP,SLP)]
     INCLUDE UTLSBP ASSIGN.VAR
     LM=1

     EQU UPDATEID TO XMISC<1>, USER TO XMISC<2>, VEND.CODE TO XMISC<3>, VEND.NUM TO XMISC<4>, VEND.NAME TO XMISC<5>
     EQU NOTE TO XMISC<6>, MAST.EFFDATE TO XMISC<7>, MAST.EXPDATE TO XMISC<8>, OPTIONS TO XMISC<9>
     EQU FILE.NAME TO XMISC<10,1>, FILE.PATH TO XMISC<10,2>, ITEM.NAME TO XMISC<11>
     EQU RUN.COUNT TO XMISC<12>
     EQU HEADER TO XMISC<13>
     EQU DELIM TO XMIS<14>
     EQU MAST.UOM TO XMISC<15>
     EQU CUSTOM.SUB TO XMISC<16>

     HEADER.PROMPTS = "Data start row:ýUPC col:ýCat num col:ýUOM col:ýEff date col:ýCost col:"
     HEADER.VALUES = ""
     *DATA.START TO HEADER.VALUES<1,1>, UPC.COL TO HEADER.VALUES<1,2>, CAT.COL TO HEADER.VALUES<1,3>, UOM.COL TO HEADER.VALUES<1,4>, EFF.DATE.COL TO HEADER.VALUES<1,5>
     *COST.COL TO HEADER.VALUES<1,6>

     PROMPT ''
     READV NEXT.UPDATE.LOG FROM LCS.CONTROL,"NEXT.PRICE.UPDATE.LOG",1 ELSE NEXT.UPDATE.LOG = ""

     UPDATE.SCOPE = "SLP"

     PRINT @(-1):
     UPDATE.LIST = ""
     COMMA = ","
     DEBUG = 0
     ERROR = ""
     ERROR.CT = 0
     UPDATES.DONE.CT = 0
     ITEM.NAME = ""
     NEW.FILES.COUNT = 0
     VENDOR.EOF = 0
     DELIMITER.NAME = TAB
     DELIMITER = CHAR(9)
     UPDATE.TYPE = "VENDOR"

     PARMS = CHANGE(@SENTENCE," ",@FM)
     DEL PARMS<1>
     LOCATE "E)" IN PARMS SETTING POS THEN DEL PARMS<POS>
     ITEM.NAME = TRIM(PARMS<1>)
     OPTIONS = TRIM(PARMS<2>)
     IF OPTIONS = "" THEN OPTIONS = "SLP"
     UPDATE.MODE = 'V'
     *
     OPEN 'UPDATE.NAME.XREF' TO UPDATE.NAME.XREF ELSE PRINT 'UPDATE.NAME.XREF';STOP
     *OPEN "I2.PRODUCT" TO I2.PRODUCT ELSE PRINT "I2.PRODUCT";STOP
     OPEN "VENDOR,ARCHIVE" TO VENDOR.ARCHIVE ELSE PRINT "VENDOR,ARCHIVE";STOP
     OPEN "VENDOR,NEW" TO VENDOR.NEW ELSE PRINT "VENDOR.NEW";STOP
     *OPEN 'CONTROL' TO CONTROL ELSE PRINT 'CONTROL';STOP
     *OPEN 'PRICE.GROUP' TO PRICE.GROUP ELSE PRINT 'PRICE.GROUP';STOP
     OPEN 'LCS.CONTROL' TO LCS.CONTROL ELSE PRINT 'LCS.CONTROL';STOP
     OPEN 'LCS.DOS' TO LCS.DOS ELSE PRINT 'LCS.DOS';STOP
     OPEN 'I2.PRICE.UPDATE.LOG' TO I2.PRICE.UPDATE.LOG ELSE PRINT 'I2.PRICE.UPDATE.LOG';STOP
     OPEN 'TS.VEND' TO TS.VEND ELSE PRINT 'TS.VEND';STOP
     *
     READV I2.PATH FROM LCS.CONTROL,"I2.PATH",1 ELSE I2.PATH = "G:\DATA_ACCOUNTS\PRICE\"

     *check command line and options
     CALL USERINFO(CONTROL,ONAME,OPER,ULEVEL,INTLS,'')
     I2.ARCHIVE.PATH = I2.PATH:UPDATE.TYPE:"\ARCHIVE\"
     I2.NEW.PATH = I2.PATH:UPDATE.TYPE:"\NEW\"

MAIN:
     IF ITEM.NAME = "" THEN
          SELECT VENDOR.NEW
          READLIST UPDATES THEN
               UP.CT = DCOUNT(UPDATES,@FM)
               FOR UP.X = 1 TO UP.CT
                    ITEM.NAME =UPCASE(UPDATES<UP.X>)
                    ITEM.NAME1 =FIELD(ITEM.NAME,'.',1)
                    ITEM.TYPE = FIELD(ITEM.NAME,'.',2)
                    GOSUB PROCESS.ITEM.NAME:
               NEXT UP.X
          END
     END ELSE
          GOSUB PROCESS.ITEM.NAME:
     END
     PRINT
     PRINT UPDATES.DONE.CT:" UPDATES COMPLETED"
     STOP

PROCESS.ITEM.NAME:
     READ LOG.ID FROM UPDATE.NAME.XREF,ITEM.NAME ELSE LOG.ID = ''
     IF LOG.ID THEN READ XMISC FROM I2.PRICE.UPDATE.LOG,LOG.ID ELSE
          LOG.ID = ""
          XMISC = ""
     END

     READV ARCHIVE.EXISTS FROM VENDOR.ARCHIVE,XMISC<10,2>:ITEM.NAME,0 ELSE ARCHIVE.EXISTS = 0

     IF NOT(ARCHIVE.EXISTS) THEN
          IF ITEM.TYPE[1,3] <> "CSV"  THEN
               DOS.SCRIPT.BODY = 'DOS /C E:\EToC.vbs ':ITEM.NAME
               IF LM THEN PRINT DOS.SCRIPT.BODY
               EXECUTE DOS.SCRIPT.BODY CAPTURING CAP
               IF LM THEN PRINT CAP
               ITEM.NAME = ITEM.NAME1:'.CSV'
          END
          DOS.CMD = 'MOVE /Y ':I2.NEW.PATH:ITEM.NAME:' ':I2.ARCHIVE.PATH
          IF LM THEN PRINT DOS.CMD
          EXECUTE "DOS /C ":DOS.CMD CAPTURING CAP
          IF LM THEN PRINT CAP
          IF NOT(LOG.ID) THEN GOSUB CREATE.NEW.UPDATE: ELSE GOSUB UPDATE.LOG:
     END
     DEBUG
     GOSUB PROCESS.UPDATE:
     RETURN

CREATE.NEW.UPDATE:
     READV LAST.LOG.ID FROM LCS.CONTROL,"LAST.PRICE.UPDATE.LOG",1 ELSE PRINT "LAST.PRICE.UPDATE.LOG NOT FOUND";STOP
     LOG.ID = LAST.LOG.ID + 1
     LOOP WHILE READ XMISC FROM I2.PRICE.UPDATE.LOG,LOG.ID DO
          LOG.ID += 1
     REPEAT
     IF LM THEN PRINT "CREATE.NEW.UPDATE:"
     XMISC = ""
     GOSUB GET.VEND.INFO:
     GOSUB UPDATE.LOG:
     IF LM THEN PRINT "UPDATE.MODE:":UPDATE.MODE
     RETURN


PROCESS.UPDATE:
     READ UPNX FROM UPDATE.NAME.XREF, UPDATE.ID ELSE
          UPNX = ""
          UPNX<1> = LOG.ID
     END
     INS UPDATE.MODE BEFORE UPNX<2,1>
     INS UPDATE.SCOPE BEFORE UPNX<3,1>
     INS "STARTED" BEFORE UPNX<4,1>
     INS DATE() BEFORE UPNX<5,1>
     INS TIME() BEFORE UPNX<6,1>
     WRITE UPNX ON UPDATE.NAME.XREF,UPDATE.ID
     OUTARGS = ""
     UPDATE.OPTIONS=UPDATE.MODE
     UPDATE.OPTIONS<2> = UPDATE.SCOPE
     GOSUB GET.HEADER.COLS:
     CALL PROCESS.TRADE.UPDATE(UPDATE.ID,UPDATE.OPTIONS,OUTARGS)
     IF OUTARGS THEN
          MESSAGE = OUTARGS<1>
          ERRORS = OUTARGS<2>
          FINISHED = TRUE
     END ELSE
          UPDATES.CT +=1
     END
     RETURN


UPDATE.LOG:
     IF LM THEN PRINT "ABOUT TO WRITE XMISC ON I2.PRICE.UPDATE.LOG";PRINT XMISC;PRINT LOG.ID
     WRITE XMISC ON I2.PRICE.UPDATE.LOG,LOG.ID
     WRITEV LOG.ID ON UPDATE.NAME.XREF,ITEM.NAME,1
     WRITEV LOG.ID ON LCS.CONTROL,"LAST.PRICE.UDPATE.LOG",1
     RETURN

GET.HEADER.COLS:
     BASE = SEQ("A") -1
     Q.CT = DCOUNT(HEADER.PROMPTS,@FM)
     FOR Q.X = 1 TO Q.CT
          IF NOT(HEADER.VALUES<1,Q.X>) THEN
               PRINT HEADER.PROMPTS<Q.X>:
               INPUT ANS,3
               IF ANS = "END" THEN STOP
               HEADER.VALUES<1,Q.X> = ANS
               PRINT
          END
          IF Q.X > 1 THEN HEADER.VALUES<1,Q.X> = SEQ(HEADER.VALUES<1,Q.X>)-BASE
     NEXT Q.X
     PRINT
     RETURN

GET.VEND.INFO:

     *evaluate - file name specified
     * VENDOR UPDATE FILE NAME PROVIDED IN FORM VEN-DDMMYY.TXT

     ITEM.NAME1 = FIELD(ITEM.NAME,".",1)
     VEN = FIELD(ITEM.NAME1,"-",1)
     EFFDATE1 = FIELD(ITEM.NAME1,"-",2)
     IF NOT(NUM(EFFDATE1)) THEN PRINT "UPDATE FILE NAME SHOULD BE IN FORMAT VEN-MMDDYY.TXT"
     EFFDATE = ICONV(EFFDATE1,"D2")
     READV TEST FROM VENDOR.NEW,ITEM.NAME,0 ELSE
          PRINT "FILE ":ITEM.NAME:" NOT FOUND IN VENDOR,NEW"
     END

     SELECT.STR = "SELECT TS.VEND WITH MAJOR.PG = ":VEN
     IF LM THEN PRINT SELECT.STR
     EXECUTE SELECT.STR CAPTURING CAP
     IF LM THEN PRINT CAP
     READLIST VEND.NUMS THEN
          QTY.FOUND = DCOUNT(VEND.NUMS,@FM)
          IF QTY.FOUND = 1 THEN
               VEND.NUM = VEND.NUMS
               READ VEND.B FROM TS.VEND,VEND.NUM  ELSE
                    PRINT "VENDOR CODE ":VEN:" DOES NOT EXIST"
                    STOP
               END
               VEND.CODE = VEN
               VEND.NAME = VEND.B<9>
          END ELSE
               PRINT QTY.FOUND:" VENDORS FOUND FOR VEND.CODE ":VEN
               PRINT "ONLY ONE EXPECTED"
               STOP
          END
     END
     RETURN


