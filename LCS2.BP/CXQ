     *$debug
     print "starting cx"

     equ tab to char(9), cr to char(13), lf to char(10)
     equ crlf to cr:lf
     equ space to char(20)
     equ comma to ","


     equ account.val to 1, period.val to 2, date.val to 3, type.val to 4, desc.val to 5
     equ amt.val to 6, bal.val to 7, source.line to 8

     equ account.id to 0, ccount.short.name to 1, account.name to 2, account.number to 3,
     equ account.start.bal to 4, account.cur.bal to 5, account.cur.bal.date to 6, state.list to 7
     equ aaccount.period to 2, acct.begin.bal to 3, acct.end.bal to 4
     equ state.list.year to 8, state.list.month to 9, state.start.date to 10, state.end.date to 11
     equ state.start.bal to 12, state.end.bal to 13

     equ start.trans.mark to "TRANSACTION DETAIL"
     equ begin.bal.mark to "Beginning Balance"
     equ end.bal.mark to "Ending Balance"
     equ primary.account.mark to "Primary Account:"

     lm =1
     s=""
     r=""

     buff = ""
     trans = ""
     header = ""
     trans.status = 0;if lm then print "trans.status=0"
     file.item.name = field(@sentence, " ", 2)
     if lm then print "file.item.name:":file.item.name
     if index(file.item.name, ",", 1) then
          txt.file.name = field(file.item.name, ",", 1)
          item.name = field(file.item.name, ",", 2)
     end else
          txt.file.name = "lcs.txt"
          item.name = file.item.name
     end
     if txt.file.name = "" then txt.file.name = "lcs.txt"
     csv.file.name = field(txt.file.name,'.',1):'.csv'
     print "txt.file.name:":txt.file.name
     print "item.name:":item.name
     item = field(item.name, ".", 1)
     ext = field(item.name, ".", 2)
     account.short = field(item,"_",1)
     account.name = field(item,"_",1):"_":field(item,"_",2)
     period.name = field(item,"_",3)
     if lm then
          print "account.name:":account.name
          print "period.name:":period.name
     end
     open 'control' to f.control else print 'control';stop
     open 'trans' to f.trans else print 'trans';stop

     open 'account' to f.account else print 'account';stop
     open 'period' to f.period else print 'period';stop
     open txt.file.name to f.txt.file else print "cannot open ":txt.file.name;stop
     open csv.file.name to f.csv.file else print "cannot open ":csv.file.name;stop
     year = field(item.name, "_", 3)[1, 4]
     yeara = "/":year
     first.beg.bal = @false
     buff3 = ""
     row=0
     read trans.id from f.control, 'trans.id' else trans.id = '1000000'
     if lm then print "trans.id:":trans.id
     read buff2 from f.txt.file,item.name then
          buff2 = change(buff2,cr,@fm)
          buff2.ct = dcount(buff2,@fm)
          for buff.x = 1 to buff2.ct
               trans = ""
               buff = buff2<buff.x>
               print "Buff (":buff.x:")":buff
               if buff[1,len(primary.account.mark)] = primary.account.mark then
                    primary.account = trim(field(buff,":",2))
                    state.date =  trim(buff2<buff.x-1>)
                    if state.date = "" then state.date =  trim(buff2<buff.x-2>)
                    *print "buff2<x>:":buff2<buff.x>
                    *print "buff2<x-1>:":buff2<buff.x-1>
                    *print "buff2<x-2>:":buff2<buff.x-2>
                    *input ans,1
                    if lm then
                         print "primary acct:":primary.account
                         print "statement.date:":state.date
                    end
                    state.date.short = change(state.date," Through ","|")
                    start.date = trim(field(state.date.short,"|",1)
                    end.date = trim(field(state.date.short,"|",2)
                    i.start.date=iconv(start.date,"D")
                    i.end.date = iconv(end.date,"D")
                    period.month = oconv(start.date,"DM")
                    period.year = oconv(start.date,"DY")
                    account.id = account.short.name:'|':primary.account
                    read account.b from account,account.id else account.b = ""
                    account.b<primary.account.val> = primary.account
                    account.b<state.date.val> = state.date
                    write account.b on account,account.id
               end else
                    if buff[1,len(start.trans.mark)] = start.trans.mark then
                         trans.status = 1;if lm then print "trans.status=1"
                         print "**** entering data zone ****"
                    end else
                         if (trans.status > 0 and buff[1,len(begin.bal.mark)] = begin.bal.mark) then
                              trans.status = 2;if lm then print "trans.status=2"
                              if not(first.beg.bal) then
                                   begin.bal = trim(field(buff,"$",2))
                                   if lm then print "************Begin bal:":begin.bal
                                   trans<desc.val> = "Beginning balance for statement ":state.date
                                   trans<amt.val> = ""
                                   trans<bal.val> = begin.bal
                                   first.beg.bal = @true
                                   gosub parse.line:
                              end
                         end else
                              if trans.status = 2 then
                                   if buff[1,len(end.bal.mark)] = end.bal.mark then
                                        end.balance = trim(field(buff,space,2))
                                        trans<desc.val> = "Ending balance for statement ":state.date
                                        trans<amt.val> = ""
                                        trans<bal.val> = trim(field(buff,space,3))
                                        trans.status=0;if lm then print "trans.status=0"
                                        gosub parse.line:
                                   end else
                                        gosub parse.line:
                                   end
                              end
                         end
                    end
               end
          next buff.x
     end

     write buff3 to f.csv.file,item:".csv"

     close f.txt.file
     close f.csv.file
     close f.trans
     write trans.id on f.control,"trans.id"
     close f.control

     stop



parse.line:
     if not(header) then
          if lm then print "**** creating header"
          gosub create.header:
     end else
          if lm then print "*****  PARSING LINE"
          trans<primary.account.val> = primary.account
          trans<state.date.val> = state.date
          trans<account.val> = account.name
          trans<period.val> = period.name
          trans<source.line> = buff
          buff = change(buff,tab,@vm)
          buff=change(buff,lf,space)
          buff=change(buff,space,@vm)
          print buff
          buff.count = dcount(buff,@vm)
          trans<date.val> = buff<1,1>:yeara
          if trans<amt.val> <> "" then trans<amt.val> = buff<1,buff.count-1>
          trans<bal.val> = buff<1,buff.count>
          trans<type.val> = buff<1,2>
          if not(trans<desc.val>) then
               for desc.x = 2 to buff.count-2
                    trans<desc.val>=trans<desc.val>:space:buff<1,desc.x>
               next desc.x
               if (buff2<buff.x+1>[3,1] <> "/" and buff2<buff.x+1>[1,len(end.bal.mark)]<>end.bal.mark) then
                    trans<desc.val>=trans<desc.val>:space:buff2<buff.x+1>
                    buff.x = buff.x + 1
               end
               trans<desc.val> = trim(trans<desc.val>)
          end
          if lm then print " ****"
     end
     gosub add.row:
     return

add.row:
     IF LM THEN PRINT "**** ADDING LINE"
     row =  row +1
     if row > 1 then
          trans.id = trans.id + 1
          trans.id.key = ("0000000":trans.id) "r#7"
          write trans on f.trans, trans.id.key
          print "trans: ":trans
          print "writing trans: ":trans.csv
     end
     trans.csv = formcsv(trans)
     buff3<row> = trans.csv
     if lm then print row:trans.csv
     return

create.header:
     row=0
     buff3 = ""
     trans<account.val> = "Account"
     trans<period.val> = "Period"
     trans<type.val> = "Type"
     trans<date.val> = "Date"
     trans<desc.val> ="Description"
     trans<amt.val> ="Amount"
     trans<bal.val> = "Balance"
     trans<primary.account.val> = "Account number"
     trans<state.date.val> = "Statement source"
     header = trans
     return


     end


