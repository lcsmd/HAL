     SUBROUTINE I2.UPDATE.TRADE(NEXT.UPDATE,UPDATE.OPTIONS.IN,OUTARGS)
     PRINT @(-1):
     DEFFUN EXTRACT.FIELD(BUFF,LABEL)
     DEFFUN CONVERT.ROLLUP.GROUP(PRICE.GROUP,F.PRICE.GROUP)
     INCLUDE UTLSBP ASSIGN.VAR
     LM=0                             ; * SET LIVE MONITORING 0=OFF 1=ON
     DM=0

     **I2.PRICE.UPDATE.LOG
     EQU UPDATE.TYPE.P TO XMISC<1>, UPDATEID TO XMISC<2>, USER TO XMISC<3>, UPDATE.NUM TO XMISC<4>
     EQU UPDATE.CODE TO XMISC<5>,  UPDATE.NAME TO XMISC<6>
     EQU NOTE TO XMISC<7>, MAST.EFFDATE TO XMISC<8>, MAST.EXPDATE TO XMISC<9>, UPDATE.MODE TO XMISC<10>
     EQU UPDATE.SCOPE TO XMISC<11>
     EQU FILE.NAME TO XMISC<12,1>, FILE.PATH TO XMISC<12,2>, ITEM.NAME TO XMISC<13>
     EQU DELIM TO XMISC<14>
     EQU COL.LABELS TO XMISC<15>
     EQU COL.VALUES TO XMISC<16>
     *EQU UPC.COL TO XMISC<16,1>, CAT.COL TO XMISC<16,2>, EFFDATE.COL TO XMISC<16,3>,COST.COL TO XMISC<16,4>, UOM.COL TO XMISC<16,5>
     EQU HEADER.LABELS TO XMISC<17>
     EQU UPC.FORMAT TO XMISC<18,1>, DATA.START TO XMISC<18,2>
     EQU CUSTOM.SUB TO XMISC<19>
     EQU MAST.UOM TO XMISC<20>
     EQU RUN.COUNT TO XMISC<21>
     EQU V.NUM TO XMISC<22>, V.NAME TO XMISC<23>, V.NEW TO XMISC<24>
     EQU V.UPDATE TO XMISC<25>, V.DELETE TO XMISC<26>, V.ZAP TO XMISC<27>
     EQU V.TOTAL TO XMISC<28>
     EQU T.NEW TO XMISC<29>, T.UPDATE TO XMISC<30>, T.DELETE TO XMISC<31>
     EQU T.ZAPPED TO XMISC<32>, T.TOTAL TO XMISC<33>

     *** DETAIL OF NEXT.PRICE.UPDATE
     EQU NEXT.TRADE.UPDATE.LOG TO NEXT.PRICE.UPDATE.LOG<1,1>
     EQU NEXT.VENDOR.UPDATE.LOG TO NEXT.PRICE.UPDATE.LOG<1,2>
     EQU NEXT.MANUAL.UPDATE.LOG TO NEXT.PRICE.UPDATE.LOG<1,3>
     EQU NEXT.REFRESH.UPDATE.LOG TO NEXT.PRICE.UPDATE.LOG<1,4>

     **** CUSTOM.PRICES - START OF EQU section
     EQU CUS.UP.DATE.H TO 1, CUS.UP.DATE TO CUS.B<1>
     EQU CUS.SOURCE.NUM.H TO 10, CUS.SOURCE.NUM TO CUS.B<10>
     EQU CUS.SOURCE.NAME.H TO 11, CUS.SOURCE.NAME TO CUS.B<11>
     EQU CUS.C4.COST.DT.H TO 12, CUS.C4.COST.DT TO CUS.B<12>
     EQU CUS.TYPE.H TO 2, CUS.TYPE TO CUS.B<2>
     EQU CUS.EFF.DATE.H TO 3, CUS.EFF.DATE TO CUS.B<3>
     EQU CUS.EXP.DATE.H TO 4, CUS.EXP.DATE TO CUS.B<4>
     EQU CUS.TS.COST.H TO 5, CUS.TS.COST TO CUS.B<5>
     EQU CUS.VEND.COST.H TO 6, CUS.VEND.COST TO CUS.B<6>
     EQU CUS.MAN.COST.H TO 7, CUS.MAN.COST TO CUS.B<7>
     EQU CUS.C4.COST.H TO 8, CUS.C4.COST TO CUS.B<8>
     EQU CUS.COST.UOM.H TO 9, CUS.COST.UOM TO CUS.B<9>
     ****CUSTOM.PRICES - END of EQU section

     OPEN 'CONTROL' TO F.CONTROL ELSE PRINT 'CONTROL' ; STOP
     OPEN 'TRADESERVICE,ARCHIVE' TO F.I2.ARCHIVE ELSE PRINT 'TRADESERVICE,ARCHIVE';STOP
     OPEN 'LCS.CONTROL' TO LCS.CONTROL ELSE PRINT 'LCS.CONTROL' ; STOP
     READV APPLY.CUSTOM.COSTS.TRADE FROM LCS.CONTROL,"APPLY.CUSTOM.COSTS.TRADE",1 ELSE APPLY.CUSTOM.COSTS.TRADE = "N"
     OPEN 'I2.PRICE.UPDATE.LOG' TO F.I2.PRICE.UPDATE.LOG ELSE PRINT 'I2.PRICE.UPDATE.LOG' ; STOP

     READ NEXT.PRICE.UPDATE.LOG FROM LCS.CONTROL,"NEXT.PRICE.UPDATE.LOG" ELSE NEXT.PRICE.UDPATE.LOG = ""
     IF NEXT.UPDATE THEN LOG.ID = NEXT.UPDATE
     READ XMISC FROM F.I2.PRICE.UPDATE.LOG,LOG.ID ELSE XMISC = ''
     UPDATE.TYPE = UPDATE.TYPE.P
     UPDATE.MODE = UPDATE.OPTIONS.IN<1>
     UPDATE.SCOPE = UPDATE.OPTIONS.IN<2>
     IF LM THEN PRINT "READING LOG.ID:":LOG.ID:"   ":XMISC
     ARC.FILE.NAME = FILE.NAME

     UPDATE.SOURCE = COUNT(UPDATE.SCOPE,"S")
     UPDATE.LIB = COUNT(UPDATE.SCOPE,"L")
     UPDATE.PRODUCT = COUNT(UPDATE.SCOPE,"P")

     IF DELIM = "" THEN
          DELIM = "COMMA"
          DELIMITER = ","
          DEBUG.MODE = 0
     END

     LOG.ID = NEXT.UPDATE
     X.ITEM = DATA.START
     TEST.LINES = 0
     LOG.CT=0
     ANS = ""
     F=""
     PROC.LOG.MODE = 1
     GOSUB INIT.VARIABLES
     GOSUB OPEN.FILES

     IF UPDATE.SOURCE THEN
          GOSUB GET.HEADER.INFO
          IF DM THEN DEBUG
     END

MAIN:
     GOSUB SHOW.HEADER:
     EOF = FALSE
     TOTAL.COUNT = 0
     LOOP
          IF TEST.LINES THEN
               IF TOTAL.COUNT > TEST.LINES THEN EOF = TRUE
          END
          PNO=''
          UPC = ""
          CATNUM = ""
          PF.B = ""
          LIB.B = ""
          I2.PIK = ""
          PF.UPC=""
          PROD.B = ""
          ORIG.B = ""

          ERROR.STATUS = 0
     UNTIL EOF DO
          TOTAL.COUNT = TOTAL.COUNT + 1
          LINE.NUM = ("000000000":TOTAL.COUNT) "R#10"
          PRICE.SOURCE.LINE.ID = LOG.ID:":":LINE.NUM
          IF UPDATE.SOURCE THEN GOSUB UPDATE.SOURCE:
          IF NOT(EOF) THEN
               IF UPDATE.LIB THEN GOSUB UPDATE.LIB:
          END
          IF NOT(MOD(TOTAL.COUNT,100)) THEN GOSUB DISPLAY.PROGRESS
          GOSUB UPDATE.COMM:
     REPEAT
     IF UPDATE.TYPE = 'T' THEN WRITE VEND.B ON F.CONTROL, 'I2.VEND'

FINISHED:
     PRINT ; PRINT
     STOP


SHOW.HEADER:
     PRINT @(1,15):"SOURCE" "R#9":"  : ":"LIBRARY" "R#9":"      ":"PRODUCT" "R#9":

     RETURN

UPDATE.SOURCE:
     UPDATE.SOURCE.CT1 += 1
     IF LM THEN PRINT "**** UPDATING SOURCE: (UPDATE TYPE:":UPDATE.TYPE:"  ":UPDATE.SOURCE.CT1

     READSEQ PF.B FROM F.I2PSVC ELSE EOF = 1

     PF.B.O = PF.B
     IF LM THEN PRINT "PF.B:":PF.B
     IF PF.B <> "" THEN
          CONVERT DELIMITER TO @FM IN PF.B
          PF.B = TRIM(PF.B,"$","A")
          PF.B = TRIM(PF.B,",","A")
          PF.B = TRIM(PF.B,'"',"A")
          PF.B = TRIM(PF.B,"-","B")
          PF.B2 = ""
          READ OPF.B FROM F.I2.PRODUCT.SOURCE,PRICE.SOURCE.LINE.ID THEN PF.B = OPF.B ELSE OPF.B = ""
          IF OPF.B <> PF.B THEN
               PF.B2 = PF.B
          END
     END
     CUS.TS.COST = ICONV(PF.B2<52>,'MD4')
     CUS.COST.UOM = PF.B2<71>
     IF CUS.TS.COST THEN
          GOSUB UPDATE.CUSTOM.PRICES:
     END
     GOSUB I2.UPDATE.KEYS:
     IF PF.B.O <> PF.B2 THEN

          RETURN

UPDATE.CUSTOM.PRICES:
          IF I2.PIK THEN
               C4.COST.NOW = ""
               READ CUS.B FROM F.CUSTOM.PRICES,I2.PIK ELSE CUS.B = ""
               CUS.B.O = CUS.B
               CUS.B<CUS.TYPE.H> = UPDATE.TYPE

               CUS.B<CUS.SOURCE.NUM.H> = PRICE.SOURCE.LINE.ID
               CUS.B<CUS.SOURCE.NAME.H> = UPDATEID
               CMD = 10000
               CP.UOM = CUS.COST.UOM
               IF CP.UOM = "EA" THEN CP.UOM = 'E'
               BEGIN CASE
                    CASE CP.UOM = 'E' ; CMD = 10000
                    CASE CP.UOM = 'C' ; CMD = 100
                    CASE CP.UOM = 'M' ; CMD = 10
               END CASE

               IF NUM(C4.COST.NOW) THEN C4.COST.NOW = C4.COST.NOW * CMD

               IF C4.COST.NOW <> CUS.C4.COST THEN
                    CUS.C4.COST = C4.COST.NOW
                    IF CUS.EFF.DATE THEN CUS.C4.COST.DT = CUS.EFF.DATE ELSE
                         CUS.C4.COST.DT = TODAY
                    END
               END
               IF CUS.B.O <> CUS.B THEN
                    CUS.UP.DATE = TODAY
                    WRITE CUS.B ON F.CUSTOM.PRICES,I2.PIK
               END
          END
          RETURN


UPDATE.LIB:
          UPDATE.LIB.CT1 += 1
          READ LIB.B FROM F.I2.PRODUCT,I2.PIK ELSE LIB.B = ""
          ALIB.B = LIB.B
          LIB.B = PF.B
          IF LIB.B <> ALIB.B THEN
               LIB.B<42> = PRICE.SOURCE.LINE.ID
               WRITE LIB.B ON F.I2.PRODUCT,I2.PIK
               UPDATE.LIB.CT2 += 1
          END
          RETURN

INIT.VARIABLES:
          NOW = DATE()
          EFFDATE = ""
          HEADER = ""
          TODAY = NOW
          OTODAY = OCONV(TODAY,"D4-")
          MONTH = ("00":FIELD(OTODAY,"-",1)) "R#2"
          DAY = ("00":FIELD(OTODAY,"-",2)) "R#2"
          YEAR = FIELD(OTODAY,"-",3)
          DATE.STAMP = YEAR:MONTH:DAY
          BEFORE.NOW = NOW
          START.TIME = TIME()
          PROC.LOG = ""
          PRICE.SOURCE.LINE.ID =0
          UPDATE.LIB.CT1 = 0
          UPDATE.LIB.CT2 = 0
          UPDATE.PRODUCT.CT1 = 0
          UPDATE.PRODUCT.CT2 = 0
          UPDATE.SOURCE.CT1 = 0
          UPDATE.SOURCE.CT2 = 0
          F = ""
          PF.HEAD.ITEMS = ""
          PF.HEAD = ""
          PF.HEAD.HEADER = ""
          NOTE = ""
          UPC.OPTIONS = ""
          MFGUCC.O = ""
          ZERO.DISC.CT = 0
          MAST.EXPDATE = ""
          UPC11 = ""
          TOTAL.COMPLETED.DATE = ""
          I2.LOG.FILE.NAME = LOG.ID:"-":DATE.STAMP
          OPENSEQ "I2.LOGS",I2.LOG.FILE.NAME TO IPUTL ELSE CREATE IPUTL ELSE PRINT "UNABLE TO CREATE I2.PRODUCT.PRICE.UPDATE.LOG.":LOG.ID:DATE.STAMP ; STOP
          IF LM THEN PRINT "STARTING INIT.VARIABLES"

          FILE.EXT = FIELD(ITEM.NAME,".",2)
          IF UPCASE(FILE.EXT) = "CSV" THEN DELIM = "COMMA"
          IF UPCASE(FILE.EXT) = 'TSV' THEN DELIM = "TAB"
          IF UPCASE(FILE.EXT) = 'TXT' THEN DELIM = 'TAB'
          IF DELIM = "TAB" THEN DELIMITER = CHAR(9)
          IF DELIM = "COMMA" THEN DELIMITER = ","
          IF LEN(DELIM) = 1 THEN DELIMITER=DELIM

          LIB.B = ""
          PROC.LOG = "CHECKPOINT 1 UPDATE:":UPDATEID:"  PATH:":FILE.NAME:"  RUN AT ":OCONV(DATE(),'D4/'):" ":OCONV(TIME(),"MHS") ; GOSUB WRITE.PROC.LOG

          PF.C1.ATT = 0

          PNO=""
          PRCLMS = 'C1':IVM:'C2':IVM:'C3':IVM:'C4':IVM:'C5':IVM:'C6':IVM:'C7':IVM:'L1':IVM:'L2':IVM:'L3':IVM:'L4'
          PRCLMS<2> = 3:IVM:5:IVM:19:IVM:62:IVM:120:IVM:122:IVM:124:IVM:13:IVM:64:IVM:66:IVM:126

          IF LM THEN PRINT @(20,20):"  UPDATE.SOURCE.CT: ":UPDATE.SOURCE.CT1
          CATNUM.ATT = 23
          UPC.ATT = 99
          EFFDATE.ATT = 44
          MAST.EXPDATE.ATT = 45
          PRICE.SOURCE.LINE.ID = 0
          PNO.ATT = 9
          PS.PIK.ATT = 1

          PREV.VEND = '' ; PREV.COMM = ''

          UPDATE.DATE = TODAY
          TOTAL.COUNT = 0
          ERROR.COUNT = 0
          UPDATE.LIB.CT2 = 0
          UPDATE.PRODUCT.CT2 = 0
          ZERO.DISC.CT = 0

          I2KEY = ''
          EOF = FALSE
          VENDOR = ""
          RETURN

GET.HEADER.INFO:
          IF LM THEN PRINT "GETTING HEADER INFO"
          I2PSVC.PATH = FILE.PATH:ITEM.NAME
          PRINT ARC.FILE.NAME:",":ITEM.NAME
          OPENSEQ ARC.FILE.NAME,ITEM.NAME TO F.I2PSVC ELSE PRINT ARC.FILE.NAME:" ":ITEM.NAME;DEBUG


          UPDATE.CODE = "T-S"
          READSEQ PF.HEAD FROM F.I2PSVC ELSE PF.HEAD = ""
          IF PF.HEAD THEN
               HEADER = PF.HEAD
               I2.HEADER = CHANGE(PF.HEAD,TAB,@FM)
               WRITE I2.HEADER ON LCS.CONTROL,"I2.HEADER"
          END
          ATT.COUNT = DCOUNT(PF.HEAD,TAB)
          IF PF.HEAD THEN PF.HEAD.HEADER = PF.HEAD
          I2COMM = UPDATEID:"-comm.txt"
          I2MEDIA = UPDATEID:"-media.tbl"
          OPENSEQ FILE.PATH:I2COMM TO F.I2COMM ELSE PRINT 'UNABLE TO OPEN ':FILE.PATH:I2COMM ; DEBUG
          IF NOT(F) THEN PROC.LOG = "TRADESERVICE FILES OPENED WITH NO ERRORS" ; GOSUB WRITE.PROC.LOG
          UPDATE.NAME = "TRADESERVICE";
          GOSUB CHECK.ERRORS:
          GOSUB COMM.DATA:


          RETURN

OPEN.FILES:
          IF LM THEN PRINT "OPENING FILES"
          OPEN 'I2.PRODUCT' TO F.I2.PRODUCT ELSE F = F:', I2.PRODUCT'

          OPEN 'PSVNO' TO F.PSVNO ELSE F = F:', PSVNO'
          OPEN 'CATVNO' TO F.CATVNO ELSE F = F:', CATVNO'
          OPEN 'PRODUCT' TO F.PRODUCT ELSE F = F:', PRODUCT'
          OPEN 'PROD.FIND' TO F.PROD.FIND ELSE F = F:', PROD.FIND'
          OPEN 'PROD.LINE' TO F.PROD.LINE ELSE F = F:', PROD.LINE'
          OPEN 'PRICE.ROLLUP' TO F.PRICE.ROLLUP ELSE F = F:', PRICE.ROLLUP'
          OPEN 'PRICE.GROUP' TO F.PRICE.GROUP ELSE F = F:', PRICE.GROUP'
          OPEN 'UPC.PSVNO.XREF' TO F.UPC.PSVNO.XREF ELSE F = F:', UPC.PSVNO.XREF'
          OPEN 'UOM' TO F.UOM ELSE F = F:', UOM'
          OPEN 'I2.PRODUCT.SOURCE' TO F.I2.PRODUCT.SOURCE ELSE PRINT 'I2.PRODUCT.SOURCE' ; STOP
          OPEN 'I2.PRODUCT.ARCHIVE' TO F.I2.PRODUCT.ARCHIVE ELSE F = F:', I2.PRODUCT.ARCHIVE'
          OPEN 'UPC.PRODUCT.XREF' TO F.UPC.PRODUCT.XREF ELSE F = F:", UPC.PRODUCT.XREF"
          OPEN 'CUSTOM.PRICES' TO F.CUSTOM.PRICES ELSE F = F:", CUSTOM.PRICES"
          OPEN 'PRICE.TRANS' TO PRICE.TRANS ELSE PRINT 'PRICE.TRANS' ; STOP
          PROC.LOG = "OPEN.FILES DONE WITH F=":F
          OPEN 'DICT','I2.PRICE.UPDATE.LOG' TO D.I2PUL ELSE PRINT "DICT,I2.PRICE.UPDATE.LOG";STOP
          OPEN 'DICT','I2.PRODUCT' TO D.I2.PRODUCT ELSE PRINT 'DICT,I2.PRODUCT';STOP
          OPEN 'I2.KEYS' TO I2.KEYS ELSE PRINT 'I2.KEYS';STOP
          OPEN 'I2.PRODUCT.SOURCE.ARC' TO F.I2.PRODUCT.SOURCE.ARC ELSE PRINT 'I2.PRODUCT.SOURCE.ARC';STOP
          OPEN ARC.FILE.NAME TO F.UP ELSE PRINT ARC.FILE.NAME ; DEBUG

          GOSUB CHECK.ERRORS:

          READ I2.HEADER FROM LCS.CONTROL, "I2.HEADER" ELSE I2.HEADER = ''

          READ OPT.B FROM F.CONTROL, 'I2.OPTIONS' ELSE OPT.B = ''
          READ NEVER.UPDATE.DESC.I2 FROM F.CONTROL,'NEVER.UPDATE.DESC.I2' ELSE NEVER.UPDATE.DESC.I2 = ''
          READ I2FT.B FROM F.CONTROL, 'I2.FIELD.TEMPLATE' ELSE I2FT.B = ''
          READ VEND.B FROM F.CONTROL, 'I2.VEND' ELSE VEND.B = ''
          READ UPD.UOM FROM F.CONTROL,"I2.UPD.UOM" ELSE UPD.UOM = "N"
          READ COMP.B FROM F.CONTROL, 'COMPANY' ELSE COMP.B = ''
          READ C4.OVERWRITABLE FROM F.CONTROL, 'C4.OVERWRITABLE' ELSE C4.OVERWRITABLE = 'N'
          GUI.SYSTEM = COMP.B<247>
          GOSUB CHECK.ERRORS

          RETURN



COMM.DATA: ***   Read and update COMMODITY DATA
          COMM.B = '' ; COUNT = 0 ; FIRST = TRUE
          EOF.C = FALSE
          LOOP
               READSEQ LINE FROM F.I2COMM THEN
                    IF FIRST THEN
                         FIRST = FALSE
                         CONVERT DELIMITER TO CHAR(253) IN LINE
                         COMM.PIK = LINE<1,1>
                         COMM.CODE= LINE<1,4>
                         COMM.DESC= LINE<1,5>
                         COUNT = COUNT + 1
                         COMM.B<1,COUNT> = COMM.PIK
                         COMM.B<2,COUNT> = COMM.CODE
                         COMM.B<3,COUNT> = COMM.DESC
                    END
               END ELSE EOF.C = TRUE
          UNTIL EOF.C DO REPEAT
          WRITE COMM.B ON F.CONTROL, 'I2.COMM'
          PROC.LOG = "WRITING ":COUNT:" RECORDS TO I2.COMM IN CONTROL FILE" ; GOSUB WRITE.PROC.LOG
          RETURN



UPDATE.COMM:
          LOCATE COMM.PIK IN VEND.B<4,VM> BY 'AR' SETTING SVM ELSE
               INS COMM.PIK BEFORE VEND.B<4,VM,SVM>
               INS '' BEFORE VEND.B<5,VM,SVM>
          END
          IF PREV.COMM # COMM.PIK THEN
               PREV.COMM = COMM.PIK
               LOCATE COMM.PIK IN COMM.B<1> SETTING VM THEN COMM.DESC = COMM.B<3,VM> ELSE COMM.DESC = COMM.PIK
          END
          RETURN

CHECK.ERRORS:
          IF F # '' THEN
               PROC.LOG = F
               GOSUB WRITE.PROC.LOG
               PRINT FILE.ERRORS:F:BCK: ; INPUT NL
               IF NL = 'D' THEN DEBUG
               IF NL = 'E' THEN GOTO FINISHED:
          END
          RETURN

WRITE.PROC.LOG:
          *IF LM THEN PRINT PROC.LOG
          IF PROC.LOG.MODE THEN
               LOG.CT += 1
               CONVERT @FM TO "|" IN PROC.LOG
               BEFORE.NOW = NOW
               NOW = DATE()
               DELTA = NOW - BEFORE.NOW
               LOG.ENTRY = NOW:":":DELTA:" ":LOG.CT:"|":UPDATEID:"-":FILE.NAME:"|":PROC.LOG
               PROC.LOG = ""
               *IF LM THEN PRINT LOG.ENTRY
               WRITESEQ LOG.ENTRY ON IPUTL ELSE PRINT 'UNABLE TO WRITE TO PROCESS LOG':IPUTL ; STOP
               BEFORE.NOW = NOW
               IF INDEX(PROC.LOG,"FATAL",1) THEN
                    ERROR.STATUS = 1
                    ERROR.COUNT = ERROR.COUNT + 1
                    WRITESEQ "*** FATAL ERROR ENCOUNTERED.  UPDATE FILE ":UPDATEID:" SKIPPED." ON IPUTL ELSE PRINT 'UNABLE TO WRITE TO PROCESS LOG':IPUTL
                    *DEBUG
               END
          END
          RETURN



DISPLAY.PROGRESS:
          NOW.TIME = TIME()
          ITEMS.DONE=UPDATE.SOURCE.CT1
          IF UPDATE.TYPE='R' THEN ITEMS.DONE=UPDATE.PRODUCT.CT1
          TIME.ELAPSED = NOW.TIME-START.TIME
          PRINT @(1,16):OCONV(UPDATE.SOURCE.CT1,'MD0,') "R#9":"    ":OCONV(UPDATE.LIB.CT1,'MD0,') "R#9":"      ":OCONV(UPDATE.PRODUCT.CT1,'MD0,') "R#9":
          PRINT @(1,17):OCONV(UPDATE.SOURCE.CT2,'MD0,') "R#9":"  : ":OCONV(UPDATE.LIB.CT2,'MD0,') "R#9":"      ":OCONV(UPDATE.PRODUCT.CT2,'MD0,') "R#9":
          IF T.TOTAL THEN PRINT @(1,19):"TOTAL ITEMS:":OCONV(T.TOTAL,"MD0,") "R#9   ":
          IF T.TOTAL > 0 THEN
               DONE = OCONV(((ITEMS.DONE/T.TOTAL)*1000),'MD1')
               IF ITEMS.DONE THEN TIM.EXPECTED = (TIME.ELAPSED*T.TOTAL)/ITEMS.DONE
               TIM.REM = (TIM.EXPECTED-TIME.ELAPSED)
               PRINT DONE:" %    ":"ELAPSED: ":OCONV(TIME.ELAPSED,'MD0,'):" SEC   REMAINING: ":TIM.REM
               SEC.REM = TIM.REM
               HOURS.REM = INT(SEC.REM/3600)
               SEC.REM = SEC.REM - HOURS.REM*3600
               MIN.REM = INT(SEC.REM/60)
               SEC.REM = SEC.REM - MIN.REM*60
               SEC.REM = INT(SEC.REM)
               PRINT "REMAINING TIME: HOURS:":HOURS.REM:"  MIN:":MIN.REM:" SEC:":SEC.REM
          END
          RETURN

I2.UPDATE.KEYS:
          IF PF.B<1> THEN
               I2.PIK = PF.B<1>
               READ KEYS FROM I2.KEYS,I2.PIK ELSE KEYS = ""
               LAST.KEY = KEYS<1>
               IF PRICE.SOURCE.LINE.ID > LAST.KEY THEN
                    LAST.KEY = PRICE.SOURCE.LINE.ID
                    KEYS<1> = LAST.KEY
               END
               READ PF.B3 FROM F.I2.PRODUCT.SOURCE,LAST.KEY THEN
                    WRITE PF.B3 ON F.I2.PRODUCT.SOURCE.ARC,LAST.KEY
                    DELETE F.I2.PRODUCT.SOURCE,LAST.KEY
               END
               MFG=PF.B<18>
               CATNUM = PF.B<22>
               CATNUM2= MFG:CATNUM
               MFGUCC = PF.B<4>
               MFG.NAME = PF.B<19>
               IF MFGUCC <> MFGUCC.O THEN
                    GOSUB UPDATE.VEND:
                    MFGUCC.O = MFGUCC
               END
               ITEMNO =PF.B<5>
               UPC = MFGUCC:ITEMNO
               KEYS<4> = PF.B<2>
               KEYS<5> = MFGUCC
               KEYS<6> = ITEMNO
               KEYS<7> = MFG
               KEYS<8> = CATNUM
               GOSUB LOOKUP.PROD:
               IF PNO THEN KEYS<9> = PNO
               KEYS<10> = LOG.ID
               READV TEST FROM F.PSVNO,I2.PIK,1 ELSE
                    WRITEV PNO ON F.PSVNO,I2.PIK,1
               END
               READV TEST FROM F.UPC.PSVNO.XREF,UPC,1 ELSE
                    WRITEV I2.PIK ON F.UPC.PSVNO.XREF,UPC,1
               END
               IF CATNUM THEN
                    READ CATBUFF.O FROM F.CATVNO,CATNUM2 ELSE CATBUFF.O = ""
                    CATBUFF = CATBUFF.O
                    CATBUFF<1> = I2.PIK
                    CATBUFF<2> = PNO
                    IF UPC THEN CATBUFF<3> = UPC
                    CATKEY = CATNUM2
                    IF CATBUFF.O <> CATBUFF THEN WRITE CATBUFF ON F.CATVNO,CATKEY
               END
          END
          WRITE KEYS ON I2.KEYS,I2.PIK
          RETURN

LOOKUP.PROD:
          PNO.T = ""
          PROD.B.T = ""
          I2.PIK.T = ""
          IF I2.PIK THEN
               PNO.T = "!":I2.PIK
               READ PROD.B.T FROM F.PRODUCT,PNO.T ELSE
                    READV PNO.T FROM F.PSVNO,I2.PIK,9 ELSE
                         SELECT.STR = "SELECT PRODUCT WITH PRICE.SRVC# = ":I2.PIK
                         EXECUTE SELECT.STR CAPTURING CAP
                         IF FIELD(CAP<2>," ",1) <> "0" THEN
                              READLIST PNOS THEN
                                   PNO.T = PNOS<1,1>
                              END
                         END
                    END
               END
          END ELSE
               IF UPC THEN
                    READV I2.PIK.T FROM F.UPC.PSVNO.XREF,UPC,1 ELSE
                         UPC = UPC[1,11]
                         READV I2.PIK.T FROM F.UPC.PSVNO.XREF,UPC,1 ELSE
                              UPC = "0":UPC
                              READV I2.PIK.T FROM F.UPC.PSVNO.XREF,UPC,1 ELSE
                                   UPC=UPC[1,11]
                                   READV I2.PIK.T FROM F.UPC.PSVNO.XREF,UPC,1 ELSE
                                        READV PNO.T FROM F.I2.PRODUCT,I2.PIK,9 ELSE
                                             READ PNO.T FROM F.PSVNO,UPC ELSE
                                                  SELECT.STR = "SELECT PRODUCT WITH UPC = ":UPC
                                                  EXECUTE SELECT.STR CAPTURING CAP
                                                  IF FIELD(CAP<2>," ",1) <> "0" THEN
                                                       READLIST PNOS THEN
                                                            PNO.T = PNOS<1,1>
                                                       END
                                                  END
                                             END
                                        END
                                   END
                              END
                         END
                    END
               END
          END
          RETURN

UPDATE.VEND:
          LOCATE MFGUCC.O IN XMISC<23> BY 'AL' SETTING VL THEN
               XMISC<24,VL> += 1
               XMISC<25,VL> += UPDATE.SOURCE.CT2
               XMISC<26,VL> += UPDATE.LIB.CT2
               XMISC<27,VL> += UPDATE.PRODUCT.CT2
               XMISC<28,VL> += ERROR.STATUS
          END ELSE
               INS MFGUCC.O BEFORE XMISC<23,VL>
               INS 1 BEFORE XMISC<24,VL>
               INS UPDATE.SOURCE.CT2 BEFORE XMISC<25,VL>
               INS UPDATE.LIB.CT2 BEFORE XMISC<26,VL>
               INS UPDATE.PRODUCT.CT2 BEFORE XMISC<27,VL>
               INS ERROR.STATUS BEFORE XMISC<28,VL>
               INS '' BEFORE XMISC<29,VL>
          END

          LOCATE MFGUCC.O IN VEND.B<1> BY 'AL' SETTING VM ELSE
               FOR I = 1 TO 10
                    INS '' BEFORE VEND.B<I,VM>
               NEXT I
               VEND.B<1,VM> = MFGUCC.O
               VEND.B<2,VM> = MFG
               VEND.B<3,VM> = MFG.NAME
          END
          RETURN

