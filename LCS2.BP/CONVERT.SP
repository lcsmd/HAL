     PROGRAM CONVERT.SP


     *F.FILES="PROD.LINE,CUS-PRD-SLS,PRD-SLS-HIST,CUS-SHP-PRD,PROD.SUB.XREF,INVENTORY,PRICE.MATRIX,PRODUCT.QUOTE.X,FUTURE.PRICE.MATRIX,PROD.CUST.PN.XREF,PRODUCT.SERIAL.XREF,CUST.PN.COMMENT,CUST.PN.XREF,PO,VM.REBATE.MATRIX,CUST.REBATE.MATRIX,OD,INVOICE,BILLING,POS,PROD.FIND,CONTROL,CPSH,CPSH.XREF,STO,INV.ADJ,PRICE.QUOTE,PROD.POINTER,DAILY.REC.REP,SLM.COMM.MATRIX,FUTURE.SLM.COMM.MATRIX,VEND.PN.XREF,BINS,INVENTORY.COST,PURCH.MATRIX,FUTURE.PURCH.MATRIX,PSVNO"
     *F.FILES = "PRODUCT"
     FOR YEAR = 1 TO 16
          YEAR = "00":YEAR "R#2"
          OPEN "SALES.":YEAR TO F.FILE ELSE PRINT "SALES.":YEAR;STOP
          GOSUB CONVERT.FILE:
          CLOSE F.FILE
     NEXT YEAR
     STOP

     TOKEN1 = "!SP*"
     TOKEN2 = "!799"
     F.FILES = CHANGE(F.FILES,",",@FM)
     F.CT = DCOUNT(F.FILES,@FM)
     FOR FX = 1 TO F.CT
          OPEN F.FILES<FX> TO F.FILE ELSE PRINT F.FILES<FX>;STOP
          GOSUB CONVERT.FILE:
          CLOSE F.FILE
     NEXT FX

CONVERT.FILE:
     SELECT F.FILE
     CT=0
     LOOP WHILE READNEXT AA DO
          CT+=1
          READ BUFF FROM F.FILE,AA THEN
               BUFFO = BUFF
               BUFF = CHANGE(BUFF,TOKEN1,TOKEN2)
          END
          PRINT FX:"   ":F.FILES<FX>:"  ":CT:" ":AA
          IF INDEX(AA,TOKEN1,1) THEN
               NAA = CHANGE(AA,TOKEN1,TOKEN2)
               WRITE BUFF ON F.FILE,NAA
               DELETE F.FILE,AA
          END ELSE
               IF BUFFO <> BUFF THEN
                    WRITE BUFF ON F.FILE,AA
               END
          END
     REPEAT
     RETURN
     
     
          READ FILES FROM F.CONTROL,'SALES.ARCHIVE' ELSE SALES.FILES=''
     SS=DCOUNT(FILES<1>,CHAR(253))
     FOR X = 1 TO SS
          SALES.FILE = FILES<1,X>
          GOSUB 600                       ; * UPDATE
     NEXT X
     !
     ! UPDATE ACCOUNT WHERE UPDATE TOOK PLACE
     !
     READU MERGE.B FROM F.PROD.MERGE.FILE, OLD.PNO THEN
          LOCATE CURRENT.ACCOUNT IN MERGE.B<2> BY 'AL' SETTING VM ELSE
               INS CURRENT.ACCOUNT BEFORE MERGE.B<2,VM>
          END
          IF DCOUNT(MERGE.B<2>,IVM) = NBR.OF.SHARED.ACCOUNTS THEN
               DELETE F.PROD.MERGE.FILE, OLD.PNO
          END ELSE
               WRITE MERGE.B ON F.PROD.MERGE.FILE, OLD.PNO
          END
     END ELSE RELEASE F.PROD.MERGE.FILE, OLD.PNO
     RETURN
     !
600: OPEN SALES.FILE TO SFILE ELSE RETURN
     READ OLD.SA.B FROM SFILE,OLD.PNO ELSE OLD.SA.B=''
     READ NEW.SA.B FROM SFILE,NEW.PNO ELSE NEW.SA.B=''
     UOM = NEW.PROD.B<97,1>
     IF UOM = '' THEN UOM = 'EA'
     UM.INARGS = UOM
     CALL UOM.SUB (NEW.PROD.B, UM.INARGS, UM.OUTARGS, '')
     QTY.FACTOR = UM.OUTARGS<1>
     PRICE.FACTOR = UM.OUTARGS<2>
     IF QTY.FACTOR = '' THEN QTY.FACTOR = 1
     IF PRICE.FACTOR = '' THEN PRICE.FACTOR = 1
     IF NEW.SA.B='' THEN
          TEMP.SA=OLD.SA.B
     END ELSE
          TEMP.SA=''
          I = DCOUNT(OLD.SA.B<1>,CHAR(253))
          FOR Z = 1 TO I
               DATE=OLD.SA.B<2,Z>
               LOCATE DATE IN TEMP.SA<2> BY 'DR' SETTING VAL ELSE NULL
               FOR J = 1 TO 13
                    INS '' BEFORE TEMP.SA<J,VAL>
                    TEMP.SA<J,VAL>=OLD.SA.B<J,Z>
               NEXT J
               FOR J = 15 TO 17
                    INS '' BEFORE TEMP.SA<J,VAL>
                    TEMP.SA<J,VAL>=OLD.SA.B<J,Z>
               NEXT J
          NEXT Z
          I = DCOUNT(NEW.SA.B<1>,CHAR(253))
          FOR Z = 1 TO I
               DATE=NEW.SA.B<2,Z>
               LOCATE DATE IN TEMP.SA<2> BY 'DR' SETTING VAL ELSE NULL
               FOR J = 1 TO 13
                    INS '' BEFORE TEMP.SA<J,VAL>
                    TEMP.SA<J,VAL>=NEW.SA.B<J,Z>
               NEXT J
               FOR J = 15 TO 17
                    INS '' BEFORE TEMP.SA<J,VAL>
                    TEMP.SA<J,VAL>=NEW.SA.B<J,Z>
               NEXT J
          NEXT Z
          TEMP.SA<14>=NEW.SA.B<14>+OLD.SA.B<14>
     END
     READV ONHANDS FROM F.INVENTORY, NEW.PNO, 1 ELSE ONHANDS = ''
     READV COST FROM F.PRODUCT, NEW.PNO, 5 ELSE COST = ''
     WCTR = 0
     LOOP
          WCTR = WCTR + 1
     WHILE WCTR LE WHSECT DO
          WHSE = WHSE.B<1,WCTR>
          WOH = ONHANDS<1,WHSE> + 0
          FOR I = 1 TO 13 ; INS '' BEFORE TEMP.SA<I,1> ; NEXT I
          TEMP.SA<1,1> = 6
          TEMP.SA<2,1> = DATE()
          TEMP.SA<3,1> = WOH
          TEMP.SA<4,1> = 'Changed from:':OCONV(OLD.PNO,'G1!1')
          TEMP.SA<6,1> = COST * PRICE.FACTOR
          TEMP.SA<7,1> = WHSE
          TEMP.SA<10,1>= COST
          FOR I = 15 TO 17 ; INS '' BEFORE TEMP.SA<I,1> ; NEXT I
          TEMP.SA<15,1> = UOM
          TEMP.SA<16,1> = PRICE.FACTOR
          TEMP.SA<17,1> = QTY.FACTOR
     REPEAT
     WRITE TEMP.SA ON SFILE, NEW.PNO
     DELETE SFILE, OLD.PNO
     RETURN

